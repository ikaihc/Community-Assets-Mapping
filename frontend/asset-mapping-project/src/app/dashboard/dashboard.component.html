<div class="dashboard-container">
  <div class="sidebar">
    <div class="user-profile">
      <!-- Show user info only if authenticated -->
      <div *ngIf="currentUser; else guestProfile">
        <div class="user-avatar">{{ getCurrentUserInitials() }}</div>
        <div class="user-email">{{ currentUser.email }}</div>

        <div class="divider" style="border-bottom: 1px solid #b3b3b3; margin: 10px 0;"></div>

        <div class="user-details">
          <div class="detail-item">
            <h3>First Name</h3>
            <p>{{ currentUser.first_name }}</p>
          </div>

          <div class="detail-item">
            <h3>Last Name</h3>
            <p>{{ currentUser.last_name }}</p>
          </div>

          <div class="detail-item">
            <h3>Role</h3>
            <p>{{ currentUser.role }}</p>
          </div>

          <div class="detail-item">
            <h3>Job Title</h3>
            <p>{{ currentUser.job_title }}</p>
          </div>
        </div>
      </div>

      <!-- Guest user profile -->
      <ng-template #guestProfile>
        <div class="user-email">Guest User</div>
        <div class="divider" style="border-bottom: 1px solid #b3b3b3; margin: 10px 0;"></div>
        <div class="guest-info">
          <p>You are browsing as a guest. Assets you create will require approval.</p>
        </div>
      </ng-template>

      <div class="divider" style="border-bottom: 1px solid #b3b3b3; margin: 10px 0;"></div>
    </div>

    <nav class="sidebar-nav" *ngIf="isAuthenticatedUser()">
      <!-- Only show user management for authenticated admin users -->
      <a
        *ngIf="currentUser && isAdmin"
        class="nav-item"
        [class.active]="activeView === 'users'"
        (click)="setActiveView('users')">
        User Management
      </a>
      <a
        *ngIf="currentUser && isNavigatorOrAdmin"
        class="nav-item"
        [class.active]="activeView === 'assets'"
        (click)="setActiveView('assets')">
        Asset Management
      </a>
    </nav>
  </div>

  <div class="main-content">
    <!-- For guest users, always show assets section -->
    <!-- For authenticated users, show based on activeView -->

    <!-- Unauthorized access message -->
    <div *ngIf="isAuthenticatedUser() && !isNavigatorOrAdmin && !isAdmin" class="content-section">
      <div class="unauthorized-message" style="text-align: center; padding: 50px;">
        <h2>Access Restricted</h2>
        <p>The dashboard is only accessible to Navigator and Administrator users.</p>
        <p>Your current role does not have access to this area.</p>
      </div>
    </div>

    <!-- Users Management Section - Only for authenticated admin users -->
    <div *ngIf="activeView === 'users' && isAuthenticatedUser() && isAdmin" class="content-section">
      <div class="section-header">
        <h1>User Management</h1>
        <button *ngIf="isAdmin" class="add-btn" (click)="onAddNewUser()">Add New User</button>
      </div>

                  <!-- Search Controls -->
            <div class="search-controls">
              <mat-form-field appearance="outline" class="search-select">
                <mat-label>Filter by</mat-label>
                <mat-select [value]="userSearchType" (selectionChange)="setUserSearchType($event.value)">
                  <mat-option value="name">Name</mat-option>
                  <mat-option value="email">Email</mat-option>
                  <mat-option value="role">Role</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="search-input">
                <mat-label>Search users...</mat-label>
                <input matInput
                       [value]="userSearchTerm"
                       (input)="setUserSearchTerm($any($event.target).value)"
                       placeholder="Enter search term">
              </mat-form-field>
            </div>

      <div class="table-container">
        <div class="loading-indicator" *ngIf="isLoadingUsers">
          Loading users...
        </div>
        <table class="data-table" *ngIf="!isLoadingUsers">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th (click)="sortUsers('first_name')" class="sortable">
                Name
                <div class="sort-arrow"
                     [class.active]="userSortField === 'first_name'"
                     [class.desc]="userSortField === 'first_name' && userSortDirection === 'desc'">

                </div>
              </th>
              <th (click)="sortUsers('role')" class="sortable">
                Role
                <div class="sort-arrow"
                     [class.active]="userSortField === 'role'"
                     [class.desc]="userSortField === 'role' && userSortDirection === 'desc'">

                </div>
              </th>
              <th>Job Title</th>
              <th (click)="sortUsers('created_at')" class="sortable">
                Date Created
                <div class="sort-arrow"
                     [class.active]="userSortField === 'created_at'"
                     [class.desc]="userSortField === 'created_at' && userSortDirection === 'desc'">

                </div>
              </th>
              <th (click)="sortUsers('updated_at')" class="sortable">
                Last Modified
                <div class="sort-arrow"
                     [class.active]="userSortField === 'updated_at'"
                     [class.desc]="userSortField === 'updated_at' && userSortDirection === 'desc'">

                </div>
              </th>
              <th>Action</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredUsers">
              <td>{{ user.id }}</td>
              <td class="email-cell">{{ user.email }}</td>
              <td>{{ getUserDisplayName(user) }}</td>
              <td>{{ user.role }}</td>
              <td>{{ user.job_title }}</td>
              <td>{{ formatDate(user.created_at) }}</td>
              <td>{{ formatDate(user.updated_at) }}</td>
              <td>
                <button
                  [class]="user.is_active ? 'deactivate-btn' : 'activate-btn'"
                  (click)="toggleUserActivation(user)">
                  {{ user.is_active ? 'Deactivate' : 'Activate' }}
                </button>
              </td>
              <td>
                <button class="edit-btn" (click)="onEditUser(user)">
                  <i class="material-icons">edit</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Assets Management Section - Only for authenticated navigator/admin users -->
    <div *ngIf="activeView === 'assets' && isAuthenticatedUser() && isNavigatorOrAdmin" class="content-section">
      <div class="section-header">
        <h1>Asset Management</h1>
        <div class="header-actions">
          <button class="add-btn primary" (click)="onAddNewAsset()">Quick Add Asset</button>
          <button class="add-btn secondary" (click)="navigateToMultiStepAssetCreation()">Multi-Step Add</button>
        </div>
      </div>

      <div class="filters">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Search by</mat-label>
          <mat-select [value]="assetSearchType" (selectionChange)="setAssetSearchType($event.value)">
            <mat-option value="name">Name</mat-option>
            <mat-option value="status">Status</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Search assets...</mat-label>
          <input matInput
                 [value]="assetSearchTerm"
                 (input)="setAssetSearchTerm($any($event.target).value)"
                 placeholder="Jane Doe">
        </mat-form-field>
      </div>

      <div class="table-container">
        <div class="loading-indicator" *ngIf="isLoadingAssets">
          Loading assets...
        </div>
        <table class="data-table" *ngIf="!isLoadingAssets">
          <thead>
            <tr>
              <th>ID</th>
              <th (click)="sortAssets('name')" class="sortable">
                Name
                <div class="sort-arrow"
                     [class.active]="assetSortField === 'name'"
                     [class.desc]="assetSortField === 'name' && assetSortDirection === 'desc'">
                </div>
              </th>
              <th (click)="sortAssets('status')" class="sortable">
                Status
                <div class="sort-arrow"
                     [class.active]="assetSortField === 'status'"
                     [class.desc]="assetSortField === 'status' && assetSortDirection === 'desc'">
                </div>
              </th>
              <th (click)="sortAssets('created_at')" class="sortable">
                Date Created ↑
                <div class="sort-arrow"
                     [class.active]="assetSortField === 'created_at'"
                     [class.desc]="assetSortField === 'created_at' && assetSortDirection === 'desc'">
                </div>
              </th>
              <th>Created By</th>
              <th (click)="sortAssets('updated_at')" class="sortable">
                Last Modified ↑
                <div class="sort-arrow"
                     [class.active]="assetSortField === 'updated_at'"
                     [class.desc]="assetSortField === 'updated_at' && assetSortDirection === 'desc'">
                </div>
              </th>
              <th>Modified By</th>
              <th>Action</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let asset of filteredAssets">
              <td>{{ asset.id }}</td>
              <td>{{ asset.name }}</td>
              <td>
                <span [class]="'status-badge status-' + asset.status">
                  {{ asset.status | titlecase }}
                </span>
              </td>
              <td>{{ formatDate(asset.created_at) }}</td>
              <td>{{ getCreatorName(asset) }}</td>
              <td>{{ formatDate(asset.updated_at) }}</td>
              <td>{{ getModifierName(asset) }}</td>
              <td>
                <button
                  class="action-btn"
                  [class.approve-btn]="asset.status === 'pending' || asset.status === 'rejected'"
                  [class.deactivate-btn]="asset.status === 'approved'"
                  (click)="toggleAssetStatus(asset)">
                  {{ asset.status === 'approved' ? 'Deactivate' : 'Activate' }}
                </button>
              </td>
              <td>
                <button class="edit-btn" (click)="onEditAsset(asset)" title="Edit Asset">
                  <i class="material-icons">edit</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Asset Pagination Controls -->
        <div class="pagination-container" *ngIf="!isLoadingAssets && getTotalAssetPages() > 1">
          <div class="pagination-info">
            <span>Showing {{ getAssetStartIndex() }}-{{ getAssetEndIndex() }} of {{ assetTotal }} assets</span>
            <span class="page-info">Page {{ assetPage }} of {{ getTotalAssetPages() }}</span>
          </div>
          <div class="pagination-controls">
            <button
              class="pagination-btn"
              (click)="prevAssetPage()"
              [disabled]="assetPage === 1">
              ← Previous
            </button>

            <button
              *ngFor="let page of getAssetPaginationPages()"
              class="pagination-btn page-number"
              [class.active]="page === assetPage"
              (click)="goToAssetPage(page)">
              {{ page }}
            </button>

            <button
              class="pagination-btn"
              (click)="nextAssetPage()"
              [disabled]="assetPage >= getTotalAssetPages()">
              Next →
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add User Form -->
    <div *ngIf="activeView === 'add-user'" class="content-section">
      <app-add-user-form
        (userAdded)="onUserAdded($event)"
        (backToUsers)="onCancelUserForm()">
      </app-add-user-form>
    </div>

    <!-- Edit User Form -->
    <div *ngIf="activeView === 'edit-user'" class="content-section">
      <app-edit-user-form
        [user]="selectedUser"
        (userUpdated)="onUserUpdated($event)"
        (cancel)="onCancelUserForm()">
      </app-edit-user-form>
    </div>

    <!-- Add Asset Form -->
    <div *ngIf="activeView === 'add-asset'" class="content-section">
      <app-add-asset-form
        (assetAdded)="onAssetAdded($event)"
        (backToAssets)="onCancelAssetForm()">
      </app-add-asset-form>
    </div>
  </div>
</div>
